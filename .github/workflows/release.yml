name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type (auto, patch, minor, major)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  id-token: write # Required for npm Trusted Publishing (OIDC)

jobs:
  release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[no-release]') && !contains(github.event.head_commit.message, 'chore(release):')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.RELEASE_DEPLOY_KEY }} # Uses deploy key to bypass branch rules

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Upgrade npm for Trusted Publishing
        run: |
          npm install -g npm@latest
          echo "npm version: $(npm --version)"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump
        id: version
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          # Determine bump type from conventional commits
          if [ "${{ inputs.release_type }}" != "auto" ]; then
            BUMP="${{ inputs.release_type }}"
          elif echo "$COMMITS" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!:"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            BUMP="minor"
          else
            BUMP="patch"
          fi

          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "Determined version bump: $BUMP"

      - name: Bump version (local only)
        id: bump
        run: |
          # Bump version without creating git tag
          NEW_VERSION=$(npm version ${{ steps.version.outputs.bump }} --no-git-tag-version)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # IMPORTANT: Publish to npm BEFORE pushing anything
      # If this fails, no commit/tag will be pushed
      - name: Publish to npm (Trusted Publishing)
        run: npm publish --access public

      # Only runs if npm publish succeeded
      - name: Commit and tag
        run: |
          git add package.json pnpm-lock.yaml
          git commit -m "chore(release): ${{ steps.bump.outputs.new_version }}" || echo "No changes to commit"
          git tag ${{ steps.bump.outputs.new_version }}

      - name: Push changes
        run: |
          # SSH key is already configured by checkout step
          git fetch origin main
          git push --force-with-lease origin main
          git push origin ${{ steps.bump.outputs.new_version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.new_version }}
          body: |
            ## Changes

            ${{ steps.changelog.outputs.changelog }}

            ## Install

            ```bash
            npm install -g hey-ai
            ```

            ## Prerequisites

            Requires the [llm CLI](https://llm.datasette.io/):
            ```bash
            brew install llm  # or: pipx install llm
            llm keys set openai
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
